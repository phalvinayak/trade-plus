const CALL="CALL",PUT="PUT",NO_OF_STRIKE=10,SHOW_CHIPS_HAWA=!1,SHOW_LTP=!0;let optionChainPrice={aggr:{CALLHawa:0,PUTHawa:0}},ticker="TICKER",strikeDiff=0,priceRange=[0,0],oldOIDiff=1e7,oldOIDiffRange=1e7,columnIndex={},totalColLength=0,strikePriceOrder={};function getColumnPosition(){if(columns=$("#oc-table-head .rt-tr>div").length,columnIndex.length&&columns==totalColLength)return columnIndex;clearChipsHawaLabels(),totalColLength=columns;let e={};return $("#sort_table_wrapper thead tr:nth-child(2) th").each((a,t)=>{let i=$(t).text().replace(/\s/g,"").toLowerCase();i.includes("ltp")&&(e.callCol?e.putCol=a+1:e.callCol=a+1),i.includes("strikeprice")&&(e.strikeCol=a+1),i.includes("oichg")&&(e.callOIChgCol?e.putOIChgCol=a+1:e.callOIChgCol=a+1),i.includes("delta")&&(e.callDelta?e.putDelta=a+1:e.callDelta=a+1),i.includes("volume")&&(e.callVolume?e.putVolume=a+1:e.callVolume=a+1),"oi"==i&&(e.callOI?e.putOI=a+1:e.callOI=a+1)}),columnIndex=e,e}function udpateStrikePCR(t,i,e){if(SHOW_CHIPS_HAWA){let a=optionChainPrice[i].percentageHawa;0==a&&(a=optionChainPrice[t].percentageHawa),e.find(".chips-hawa-pcr-ratio.p-hawa").length?e.find(".chips-hawa-pcr-ratio.p-hawa").text(parseFloat(a).toFixed(2)+"%"):e.prepend(`<span class='chips-hawa-pcr-ratio p-hawa'>${parseFloat(a).toFixed(2)}%</span>`)}oiRatio=optionChainPrice[i].oiChangeRatio,e.find(".chips-hawa-pcr-ratio.pcr").length?e.find(".chips-hawa-pcr-ratio.pcr").text(oiRatio):e.append(`<div class='chips-hawa-pcr-ratio pcr'>${oiRatio}</div>`)}function getTicker(){var a=$("#optSymbol").val();return a||null}function updateTableHeader(a,t,i){$headerRow=$("#sort_table_wrapper thead tr:nth-child(2)"),0==$headerRow.find(".chips-hawa-price").length&&(SHOW_CHIPS_HAWA&&$headerRow.find(`th:nth-child(${a})`).prepend("<span class='chips-hawa-price chips'>CHIPS</span>"),SHOW_CHIPS_HAWA&&$headerRow.find(`th:nth-child(${a})`).append("<span class='chips-hawa-price hawa'>HAWA</span>"),SHOW_CHIPS_HAWA&&$headerRow.find(`th:nth-child(${t})`).prepend("<span class='chips-hawa-price chips'>CHIPS</span>"),SHOW_CHIPS_HAWA&&$headerRow.find(`th:nth-child(${t})`).append("<span class='chips-hawa-price hawa'>HAWA</span>"),$headerRow.find(`th:nth-child(${i})`).append("<span class='chips-hawa-price chips-hawa-pcr-ratio pcr'>COI-R</span>"),SHOW_CHIPS_HAWA&&$headerRow.find(`th:nth-child(${i})`).prepend("<span class='chips-hawa-price p-hawa'>%HAWA</span>"))}function updateChipsHawa(){var a=getTicker();a&&ticker==a||(ticker=a,optionChainPrice={aggr:{CALLHawa:0,PUTHawa:0}},strikeDiff=0,oldOIDiff=0);let v=getFuturePrice();if(v){let m=getColumnPosition(),P=[0,0];updateTableHeader(m.callCol,m.putCol,m.strikeCol),$("#sort_table_wrapper tbody tr").each((a,t)=>{let i=$(t),e=i.find(`td:nth-child(${m.strikeCol})`),p=i.find(`td:nth-child(${m.callCol})`),n=i.find(`td:nth-child(${m.putCol})`),o=i.find(`td:nth-child(${m.callOIChgCol})`),s=i.find(`td:nth-child(${m.putOIChgCol})`);var l=i.find(`td:nth-child(${m.callDelta})`),c=i.find(`td:nth-child(${m.putDelta})`);let r=i.find(`td:nth-child(${m.callVolume})`),h=i.find(`td:nth-child(${m.putVolume})`);var d=i.find(`td:nth-child(${m.callOI})`),u=i.find(`td:nth-child(${m.putOI})`);let C=e.find("a").text().trim();C=parseFloat(C).toFixed(2);var w=C+"-"+CALL,t=C+"-"+PUT;strikePriceOrder[a+1]=C,parseFloat(C)<parseFloat(v)&&(P[0]=a+1,P[1]=a+2),optionChainPrice[w]||(optionChainPrice[w]={},optionChainPrice[t]={},optionChainPrice[w].strike=C,optionChainPrice[t].strike=C,optionChainPrice[w].index=a+1,optionChainPrice[t].index=a+1,optionChainPrice[w].chips=-1,optionChainPrice[w].hawa=-1,optionChainPrice[t].chips=-1,optionChainPrice[t].hawa=-1),SHOW_CHIPS_HAWA&&0==i.find("span.chips-hawa-price").length&&(p.prepend(`<span class='chips-hawa-price chips'>${optionChainPrice[w].chips}</span>`),p.append(`<span class='chips-hawa-price hawa'>${optionChainPrice[w].hawa}</span>`),n.prepend(`<span class='chips-hawa-price chips'>${optionChainPrice[t].chips}</span>`),n.append(`<span class='chips-hawa-price hawa'>${optionChainPrice[t].hawa}</span>`)),renderAndUpdateGlobalState(C,v,p,CALL),renderAndUpdateGlobalState(C,v,n,PUT),highlightChangeOI(w,t,o,s),setOIRatio(w,t,d,u),readColumnValues(w,t,l,c,r,h),udpateStrikePCR(t,w,e),SHOW_LTP&&(r.off("click").on("click",this,a=>{a.preventDefault(),bindVolumeEvent(CALL,C)}),h.off("click").on("click",this,a=>{a.preventDefault(),bindVolumeEvent(PUT,C)})),o.hasClass("chips-hawa-col-event")||(o.addClass("chips-hawa-col-event"),s.addClass("chips-hawa-col-event"));let f=e.find("a").text().trim();o.off("click").on("click",this,a=>{a.preventDefault(),openPage(`https://options.icharts.in/opt/OptionsMonitor.php?symbol=${encodeURIComponent(ticker)}&strike=`+f)}),s.off("click").on("click",this,a=>{a.preventDefault(),openPage(`https://options.icharts.in/opt/OptionsMonitor.php?symbol=${encodeURIComponent(ticker)}&strike=`+f)})}),0!=P[1]&&($(".chips-hawa-imaginary-line").removeClass("chips-hawa-imaginary-line"),$(`#sort_table_wrapper tbody tr:nth-child(${P[1]})`).addClass("chips-hawa-imaginary-line"))}}function openPage(a){let t=window.open(a,"_blank");t?t.focus():alert("Please allow popups for this website")}function bindVolumeEvent(a,t){var i=t+"-"+a,i=optionChainPrice[i];let e=i.strike+"-CALL",p=strikePriceOrder[i.index-1]+"-PUT",n=parseFloat(optionChainPrice[p].strike)-1,o="Bearish";a==CALL&&(o="Bullish",p=i.strike+"-PUT",e=strikePriceOrder[i.index+1]+"-CALL",n=parseFloat(optionChainPrice[e].strike)+1),optionChainPrice[p]&&optionChainPrice[e]?(a=optionChainPrice[e],i=optionChainPrice[p],ltpCalculator(o,a.price,parseFloat(a.delta),i.price,parseFloat(-1*i.delta),t,parseFloat(n).toFixed(2))):ltpCalculator("error",0,0,0,0,t,parseFloat(n).toFixed(2))}function ltpCalculator(a,t,i,e,p,n,o){let s=0;var l=getFuturePrice();s="error"==a?"No Pair Data":"Bullish"==a?($(".chips-hawa-ltp-output").addClass("bearish"),parseFloat(e)<parseFloat(t)?"Breakout":(s=l+(parseFloat(e)-parseFloat(t))/(i+p)+.05,isNumeric(parseFloat(s).toFixed(2))?parseFloat(s).toFixed(2):"Data Error")):($(".chips-hawa-ltp-output").removeClass("bearish"),parseFloat(t)<parseFloat(e)?"Breakdown":(s=l-(parseFloat(t)-parseFloat(e))/(i+p)-.05,isNumeric(parseFloat(s).toFixed(2))?parseFloat(s).toFixed(2):"Data Error")),$(".ltp-params-item.spot .value").text(l),$(".ltp-params-item.direction .value").text(a),$(".ltp-params-item.ce-price .value").text(t),$(".ltp-params-item.ce-delta .value").text(i),$(".ltp-params-item.pe-price .value").text(e),$(".ltp-params-item.pe-delta .value").text(p),$(".ltp-params-item.strike .value").text(n),$(".chips-hawa-ltp-output .output-price").text(s),$(".chips-hawa-ltp-output .output-sl").text("SL-"+o),$(".chips-hawa-overlay").removeClass("hide")}function readColumnValues(a,t,i,e,p,n){var o=p.text().trim().replace(/\,/g,""),s=n.text().trim().replace(/\,/g,""),i=i.text().trim().replace(/\,/g,""),e=e.text().trim().replace(/\,/g,"");optionChainPrice[a].volume=o,optionChainPrice[a].delta=i,optionChainPrice[t].volume=s,optionChainPrice[t].delta=e,SHOW_LTP&&!p.hasClass("chips-hawa-col-event")&&(p.addClass("chips-hawa-col-event"),n.addClass("chips-hawa-col-event"))}function renderAndUpdateGlobalState(a,t,i,e){var p=i.find("a").text().trim().replace(/\,/g,"");[chips,hawa]=getChipsHawa(t,a,p,e);a=a+"-"+e;!SHOW_CHIPS_HAWA||optionChainPrice[a].chips===chips&&optionChainPrice[a].hawa===hawa||(i.find("span.chips-hawa-price.chips").text(chips),i.find("span.chips-hawa-price.hawa").text(hawa)),optionChainPrice[a].price=p,optionChainPrice[a].chips=chips,optionChainPrice[a].hawa=hawa,0!=chips?optionChainPrice[a].percentageHawa=hawa/p*100:optionChainPrice[a].percentageHawa=0,optionChainPrice.aggr[e+"Hawa"]+=parseFloat(hawa)}function renderHawaComparision(a){$("#sort_table_wrapper tfoot tr:nth-child(1) th:nth-child(6)").text("CE-Hawa"),$("#sort_table_wrapper tfoot tr:nth-child(1) th:nth-child(8)").text("PE-Hawa"),$("#sort_table_wrapper tfoot tr:nth-child(2) th:nth-child(6)").text(parseFloat(a.CALLHawa).toFixed(0)),$("#sort_table_wrapper tfoot tr:nth-child(2) th:nth-child(8)").text(parseFloat(a.PUTHawa).toFixed(0))}function getFuturePrice(){if("future"==$("input[name=chips-hawa-asset-price]:checked").val()){if($("#FuturesData div span>span:nth-child(1)").length)return parseFloat($("#FuturesData div span>span:nth-child(1)").text().trim())}else if($("#FuturesData div span>span:nth-child(1)").length)return parseFloat($("#SpotPriceData div span:nth-child(2)").text().trim());return!1}function getChipsHawa(a,t,i,e){let p=0,n=0;return 0==i||"NaN"===i||(e===CALL?p=t<a?(n=a-t,i-n):i:e===PUT&&(p=a<t?(n=t-a,i-n):i),n=parseFloat(n).toFixed(2),p=parseFloat(p).toFixed(2)),[n,p]}function clearChipsHawaLabels(){$("#oc-table-body span.chips-hawa-price").remove(),$("#oc-table-body span.chips-hawa-pcr-ratio").remove(),optionChainPrice={aggr:{CALLHawa:0,PUTHawa:0}}}function isNumeric(a){return"string"==typeof a&&(!isNaN(a)&&!isNaN(parseFloat(a)))}function highlightChangeOI(a,t,i,e){let p=i.text().trim().replace(/\,/g,""),n=e.text().trim().replace(/\,/g,"");p=isNumeric(p)?parseInt(p,10):0,n=isNumeric(n)?parseInt(n,10):0,optionChainPrice[a].oiChange=p,optionChainPrice[t].oiChange=n;let o="";o=0<p&&0<n?p>n?getRatio(p,n)+" :: 1":"1 :: "+getRatio(n,p):p<0&&n<0?p>n?o="1 :: "+getRatio(-1*n,-1*p):getRatio(-1*p,-1*n)+" :: 1":"∞",optionChainPrice[a].oiChangeRatio=o,optionChainPrice[t].oiChangeRatio=o,i.hasClass("chips-hawa-OI-change")||(i.addClass("chips-hawa-OI-change"),e.addClass("chips-hawa-OI-change"))}function setOIRatio(a,t,i,e){let p=i.find("div").text().trim().replace(/\,/g,""),n=e.find("div").text().trim().replace(/\,/g,"");p=isNumeric(p)?parseInt(p,10):0,n=isNumeric(n)?parseInt(n,10):0,optionChainPrice[a].oi=p,optionChainPrice[t].oi=n;let o="";o=0<p&&0<n?p>n?getRatio(p,n)+" :: 1":"1 :: "+getRatio(n,p):"∞",i.addClass("chips-hawa-tooltip"),e.addClass("chips-hawa-tooltip"),i.find(".chips-hawa-tooltip-content").length?(i.find(".chips-hawa-tooltip-content").text("OI Ratio: "+o),e.find(".chips-hawa-tooltip-content").text("OI Ratio: "+o)):(i.append(`<p class="chips-hawa-tooltip-content oi-ratio">OI Ratio: ${o}</p>`),e.append(`<p class="chips-hawa-tooltip-content oi-ratio">OI Ratio: ${o}</p>`)),optionChainPrice[a].oiRatio=o,optionChainPrice[t].oiRatio=o}function getRatio(a,t){t=parseFloat(a/t).toFixed(1);return parseInt(t)==t?parseInt(t):t}function initUI(){location.href.endsWith("OptionChain.php")&&0==$("li.chips-hawa-asset-price-option").length&&$("#main-menu").append(`<li class="telegramclass chips-hawa-asset-price-option">
					<div>Asset Price Option</div>
					<label><input type="radio" name="chips-hawa-asset-price" id="chips-hawa-fut" value="future">Future</label>
					<label><input type="radio" name="chips-hawa-asset-price" id="chips-hawa-spot" value="spot" checked>Spot</label>
				</li>`),$("body").append(`
		<div class="chips-hawa-overlay ichart hide">
			<div class="chips-hawa-ltp-content">
				<h4>LTP Calculator</h4>
				<div class="chips-hawa-ltp-body chips-hawa-clearfix">
					<div class="chips-hawa-ltp-params">
						<div class="ltp-params-item spot">
							<span class="key">Spot : </span>
							<span class="value"></span>
						</div>
						<div class="ltp-params-item direction">
							<span class="key">Direction : </span>
							<span class="value"></span>
						</div>
						<div class="ltp-params-item ce-price">
							<span class="key">CE Ltp : </span>
							<span class="value"></span>
						</div>
						<div class="ltp-params-item ce-delta">
							<span class="key">CE Delta : </span>
							<span class="value"></span>
						</div>
						<div class="ltp-params-item pe-price">
							<span class="key">PE Ltp : </span>
							<span class="value"></span>
						</div>
						<div class="ltp-params-item pe-delta">
							<span class="key">PE Delta : </span>
							<span class="value"></span>
						</div>
						<div class="ltp-params-item strike">
							<span class="key">Strike : </span>
							<span class="value"></span>
						</div>
					</div>
					<div class="chips-hawa-ltp-output">
						<span class="output-price">--</span>
						<span class="output-sl">--</span>
					</div>
				</div>
			</div>
		</div>
	`),$(".chips-hawa-overlay").on("click",a=>{a.preventDefault(),a.stopPropagation(),$(".chips-hawa-overlay").addClass("hide")}),$(".chips-hawa-ltp-content").on("click",a=>{a.preventDefault(),a.stopPropagation()})}function main(){initUI(),updateChipsHawa(),$("#diffoichange").bind("DOMSubtreeModified",updateChipsHawa)}function updateOIStrike(){const a=window.location.href,t=new URL(a);var i,e;a.includes("OptionsMonitor.php")&&(i=t.searchParams.get("strike"),e=t.searchParams.get("symbol"),i&&($("#optSymbol").val(e).change(),$("#optCallStrike, #optPutStrike").append(`<option value="${i}">${i}</option>`),$("#optCallStrike").val(i).change(),$("#optPutStrike").val(i).change(),history.pushState({},null,t.pathname),$("button[name=btnSubmit]").trigger("click")))}location.href.endsWith("OptionChain.php")&&main(),$(()=>{updateOIStrike(),$("body").on("mouseenter",".chips-hawa-tooltip",a=>{$(a.target).closest("td").find(".chips-hawa-tooltip-content").show()}).on("mouseleave",".chips-hawa-tooltip",a=>{$(a.target).closest("td").find(".chips-hawa-tooltip-content").hide()})});